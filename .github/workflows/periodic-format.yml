name: Periodic Format

on:
  workflow_dispatch:
  pull_request:
  schedule:
    - cron: '0 1 * * 1,3,6'  # every day at midnight

env:
  BUILD_TYPE: Release

jobs:
  format:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      
    - name: Init Submodules
      uses: snickerbockers/submodules-init@v4

    - name: Cache LLVM and Clang
      if: matrix.compiler == 'clang'
      id: cache-llvm
      uses: actions/cache@v2
      with:
        path: ${{ runner.temp }}/llvm
        key: llvm-11.0
    - name: Install LLVM and Clang
      if: matrix.compiler == 'clang'
      uses: KyleMayes/install-llvm-action@v1
      with:
        version: "11.0"
        directory: ${{ runner.temp }}/llvm
        cached: ${{ steps.cache-llvm.outputs.cache-hit }}
        

    - name: Create Build Environment
      # Some projects don't allow in-source building, so create a separate build directory
      # We'll use this as our working directory for all subsequent commands
      run: cmake -E make_directory ${{github.workspace}}/Build

    - name: Configure CMake
      shell: bash
      run: cmake -S ${{github.workspace}} -B ${{github.workspace}}/Build -DCMAKE_BUILD_TYPE=$BUILD_TYPE
  
    - name: Format
      shell: bash
      run: cmake --build Build --config $BUILD_TYPE --target ClangFormat
      
    - name: Commit & Push changes
      uses: actions-js/push@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        author_email: 'info@piperift.com'
        author_name: 'Automatron'
        message: 'Periodic format'
